#!/bin/bash
# Postinstallation script for linux-hello

set -e

echo "Linux Hello - Postinstallation Configuration"
echo "=============================================="
echo ""

# Create storage directory
STORAGE_DIR="${HOME}/.local/share/linux-hello"
mkdir -p "$STORAGE_DIR" 2>/dev/null || true
chmod 700 "$STORAGE_DIR" 2>/dev/null || true

echo "✓ Daemon service installed"

# Activer et lancer le daemon pour l'utilisateur qui a lancé l'installation
TARGET_USER="${SUDO_USER}"
if [ -z "$TARGET_USER" ]; then
    # Si pas de SUDO_USER, on est peut-être lancé directement en root
    # On essaie de trouver l'utilisateur principal
    TARGET_USER=$(who | head -1 | awk '{print $1}')
fi

if [ -n "$TARGET_USER" ] && [ "$TARGET_USER" != "root" ]; then
    echo "Enabling daemon for user: $TARGET_USER"
    sudo -u "$TARGET_USER" systemctl --user enable hello-daemon.service 2>/dev/null || true
    sudo -u "$TARGET_USER" systemctl --user start hello-daemon.service 2>/dev/null || true
    echo "✓ Daemon enabled and started"
fi

# Non-interactive installation (no PAM config by default)
# Users can configure PAM manually or re-run configuration tool
pam_option="4"

case "$pam_option" in
    1)
        # Configure sudo
        if [ -f /etc/pam.d/sudo ]; then
            # Backup existing
            cp /etc/pam.d/sudo "/etc/pam.d/sudo.backup.$(date +%s)"
            
            # Add linux-hello at the beginning if not already present
            if ! grep -q "pam_linux_hello" /etc/pam.d/sudo; then
                echo "auth sufficient /lib/x86_64-linux-gnu/security/pam_linux_hello.so context=sudo timeout_ms=3000" | \
                    cat - /etc/pam.d/sudo > /tmp/sudo.new && \
                    mv /tmp/sudo.new /etc/pam.d/sudo
                echo "✓ Configured /etc/pam.d/sudo"
            else
                echo "✓ /etc/pam.d/sudo already configured"
            fi
        fi
        ;;
    2)
        # Configure screenlock
        if [ -f /etc/pam.d/kde ]; then
            cp /etc/pam.d/kde "/etc/pam.d/kde.backup.$(date +%s)"
            
            if ! grep -q "pam_linux_hello" /etc/pam.d/kde; then
                echo "auth sufficient /lib/x86_64-linux-gnu/security/pam_linux_hello.so context=screenlock timeout_ms=3000" | \
                    cat - /etc/pam.d/kde > /tmp/kde.new && \
                    mv /tmp/kde.new /etc/pam.d/kde
                echo "✓ Configured /etc/pam.d/kde"
            fi
        fi
        ;;
    3)
        # Both
        if [ -f /etc/pam.d/sudo ]; then
            cp /etc/pam.d/sudo "/etc/pam.d/sudo.backup.$(date +%s)"
            if ! grep -q "pam_linux_hello" /etc/pam.d/sudo; then
                echo "auth sufficient /lib/x86_64-linux-gnu/security/pam_linux_hello.so context=sudo timeout_ms=3000" | \
                    cat - /etc/pam.d/sudo > /tmp/sudo.new && \
                    mv /tmp/sudo.new /etc/pam.d/sudo
            fi
        fi
        
        if [ -f /etc/pam.d/kde ]; then
            cp /etc/pam.d/kde "/etc/pam.d/kde.backup.$(date +%s)"
            if ! grep -q "pam_linux_hello" /etc/pam.d/kde; then
                echo "auth sufficient /lib/x86_64-linux-gnu/security/pam_linux_hello.so context=screenlock timeout_ms=3000" | \
                    cat - /etc/pam.d/kde > /tmp/kde.new && \
                    mv /tmp/kde.new /etc/pam.d/kde
            fi
        fi
        
        echo "✓ Configured sudo and screenlock"
        ;;
    *)
        echo "✓ PAM configuration skipped (manual configuration needed)"
        ;;
esac

# Daemon setup is skipped during package installation (no user session available)
# Users can enable autostart manually with: systemctl --user enable hello-daemon.service
echo "✓ Daemon setup (manual configuration can be done via: systemctl --user enable hello-daemon.service)"

echo ""
echo "Installation Complete!"
echo ""
echo "Next steps:"
echo "1. Register a face: hello-daemon (in one terminal) then use:"
echo "   dbus-send --session --print-reply ..."
echo "2. Test with sudo: sudo -v"
echo "3. Or test with screenlock: lock your screen"
echo ""
echo "For help: man linux-hello"
echo ""

exit 0
